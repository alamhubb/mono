# monorepo-cli

ä¸€ä¸ªè§£å†³ Node.js conditions å…¨å±€æ±¡æŸ“é—®é¢˜çš„ CLI å·¥å…·ã€‚

## æ ¸å¿ƒç—›ç‚¹

åœ¨ Monorepo å¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¸Œæœ›ï¼š
- **å¼€å‘æ—¶**ï¼šç›´æ¥å¼•ç”¨æœ¬åœ°åŒ…çš„ **æºç **ï¼ˆ`src/index.ts`ï¼‰ï¼Œäº«å—çƒ­æ›´æ–°ã€æ— éœ€ç¼–è¯‘
- **ç”Ÿäº§æ—¶**ï¼šå¼•ç”¨ **ç¼–è¯‘äº§ç‰©**ï¼ˆ`dist/index.js`ï¼‰ï¼Œç¡®ä¿å…¼å®¹æ€§

ä½†ç°æœ‰æ–¹æ¡ˆéƒ½æœ‰é—®é¢˜ï¼š

### âŒ `node --conditions` çš„å…¨å±€æ±¡æŸ“

```bash
node --conditions=development app.js
```

`development` æ¡ä»¶ä¼šå½±å“**æ‰€æœ‰åŒ…**ï¼ŒåŒ…æ‹¬ `node_modules` ä¸­çš„ç¬¬ä¸‰æ–¹ä¾èµ–ã€‚å¦‚æœ `axios` æˆ– `vue` ä¹Ÿå®šä¹‰äº† `development` æ¡ä»¶ï¼Œå°±ä¼š**æ„å¤–è§¦å‘å®ƒä»¬çš„å¼€å‘ç‰ˆæœ¬**ï¼Œå¯¼è‡´ä¸å¯é¢„çŸ¥çš„è¡Œä¸ºã€‚

### âŒ `tsconfig paths` çš„ç»´æŠ¤è´Ÿæ‹…

```json
{
  "compilerOptions": {
    "paths": {
      "@my/utils": ["packages/utils/src/index.ts"],
      "@my/core": ["packages/core/src/index.ts"]
      // æ¯å¢åŠ ä¸€ä¸ªåŒ…éƒ½è¦æ‰‹åŠ¨ç»´æŠ¤...
    }
  }
}
```

éœ€è¦**æ‰‹åŠ¨ç»´æŠ¤**æ¯ä¸ªåŒ…çš„è·¯å¾„æ˜ å°„ï¼Œå®¹æ˜“ä¸ `package.json` ä¸åŒæ­¥ï¼Œè¿˜éœ€è¦é¢å¤–çš„ `tsconfig-paths` loaderã€‚

## è§£å†³æ–¹æ¡ˆ

`mono` æ˜¯ `tsx` çš„é€æ˜å¥—å£³ï¼Œé€šè¿‡ `monorepo` å­—æ®µå®ç°**é€‰æ‹©æ€§**å…¥å£åˆ‡æ¢ï¼š

```json
{
  "name": "@my/utils",
  "main": "./dist/index.js",
  "monorepo": "./src/index.ts"
}
```

- `mono app.ts` â†’ æœ¬åœ°åŒ…ç”¨æºç ï¼Œç¬¬ä¸‰æ–¹åŒ…**ä¸å—å½±å“**
- `tsx app.ts` â†’ æ‰€æœ‰åŒ…ç”¨é»˜è®¤å…¥å£ï¼ˆç¼–è¯‘äº§ç‰©ï¼‰

## ä¸ºä»€ä¹ˆé€‰æ‹© mono

### æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | éš”ç¦»æ€§ | é…ç½®å¤æ‚åº¦ | ç¬¬ä¸‰æ–¹åŒ…å®‰å…¨ | npm å®Œç¾å…¼å®¹ |
|------|--------|-----------|-------------|--------------|
| `--conditions` | âŒ å…¨å±€ç”Ÿæ•ˆ | âœ… ç®€å• | âŒ ä¼šè¢«æ±¡æŸ“ | âœ… æ— éœ€æ”¹é€  |
| `pnpm workspace:*` | âœ… æŒ‰åŒ…é…ç½® | âš ï¸ éœ€é¢å¤–é…ç½® | âœ… å®‰å…¨ | âŒ éœ€æ”¹é€ ä¾èµ– |
| `tsconfig paths` | âœ… æŒ‰åŒ…é…ç½® | âŒ éœ€æ‰‹åŠ¨ç»´æŠ¤ | âœ… å®‰å…¨ | âŒ éœ€æ”¹é€ é…ç½® |
| **mono** | âœ… ä»…æœ¬åœ°åŒ… | âœ… ä¸€ä¸ªå­—æ®µ | âœ… å®‰å…¨ | âœ… æ— éœ€æ”¹é€  |

### mono çš„æ ¸å¿ƒä¼˜åŠ¿

| ç‰¹æ€§ | mono | å…¶ä»–æ–¹æ¡ˆ |
|------|------|----------|
| ğŸ›¡ï¸ **é˜²æ±¡æŸ“** | ä»…å¯¹ monorepo æœ¬åœ°åŒ…ç”Ÿæ•ˆ | --conditions ä¼šæ±¡æŸ“ node_modules |
| âš¡ **é›¶é…ç½®** | è‡ªåŠ¨è¯†åˆ« npm çš„ workspaces | tsconfig paths éœ€æ‰‹åŠ¨ç»´æŠ¤ |
| ğŸ”§ **npm å…¼å®¹** | å®Œç¾å…¼å®¹ npm | pnpm workspace:* éœ€æ”¹é€ ï¼Œä¸å…¼å®¹ npm |

## å®‰è£…

```bash
npm install -g monorepo-cli
```

**å‰ç½®ä¾èµ–**ï¼šéœ€è¦å…¨å±€å®‰è£… tsx
```bash
npm install -g tsx
```

## ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬ç”¨æ³•

`mono` å‘½ä»¤ç”¨æ³•ä¸ `tsx` å®Œå…¨ä¸€è‡´ï¼š

```bash
# åŸæ¥æ€ä¹ˆç”¨ tsx
tsx app.ts
tsx --no-cache app.ts

# ç°åœ¨æ€ä¹ˆç”¨ monoï¼ˆå‚æ•°åŸæ ·ä¼ é€’ç»™ tsxï¼‰
mono app.ts
mono --no-cache app.ts
```

### é…ç½®

1. æ ¹ç›®å½• `package.json` ä¸­é…ç½® workspacesï¼š

```json
{
  "workspaces": ["packages/*"]
}
```

2. åœ¨éœ€è¦è‡ªå®šä¹‰å…¥å£çš„æœ¬åœ°åŒ…çš„ `package.json` ä¸­æ·»åŠ  `monorepo` å­—æ®µï¼š

```json
{
  "name": "@my-mono/utils",
  "main": "./dist/index.js",
  "monorepo": "./src/index.ts"
}
```

### æ•ˆæœ

- é€šè¿‡ `mono` è¿è¡Œæ—¶ï¼š`import "@my-mono/utils"` â†’ è§£æåˆ° `./src/index.ts`ï¼ˆæºç ï¼‰
- é€šè¿‡ `tsx` è¿è¡Œæ—¶ï¼š`import "@my-mono/utils"` â†’ è§£æåˆ° `./dist/index.js`ï¼ˆç¼–è¯‘äº§ç‰©ï¼‰

## å®ç°åŸç†

### æ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         mono CLI                            â”‚
â”‚                      (bin/mono.mjs)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚ è°ƒç”¨
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          tsx                                â”‚
â”‚                  --import=loader.mjs                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚ æ³¨å†Œ
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Node.js ESM Loader Hooks                       â”‚
â”‚                   (hooks.mjs)                               â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              resolve(specifier, ...)                 â”‚   â”‚
â”‚  â”‚                                                      â”‚   â”‚
â”‚  â”‚  1. æ£€æŸ¥æ˜¯å¦æ˜¯ workspace åŒ…                          â”‚   â”‚
â”‚  â”‚  2. è¯»å–è¯¥åŒ…çš„ package.json                          â”‚   â”‚
â”‚  â”‚  3. å¦‚æœæœ‰ monorepo å­—æ®µï¼Œè¿”å›è¯¥è·¯å¾„                 â”‚   â”‚
â”‚  â”‚  4. å¦åˆ™ä½¿ç”¨é»˜è®¤è§£æé€»è¾‘                             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒæ–‡ä»¶è¯´æ˜

#### 1. `bin/mono.mjs` - CLI å…¥å£

```javascript
// è·å– loader è·¯å¾„
const loaderUrl = pathToFileURL(join(__dirname, '..', 'src', 'loader.mjs')).href;

// è°ƒç”¨ tsxï¼Œæ³¨å…¥ loader
spawn('tsx', [`--import=${loaderUrl}`, ...args], { stdio: 'inherit' });
```

**ä½œç”¨**ï¼šä½œä¸º tsx çš„ä»£ç†ï¼Œåœ¨å¯åŠ¨æ—¶é€šè¿‡ `--import` å‚æ•°æ³¨å…¥è‡ªå®šä¹‰çš„ ESM Loaderã€‚

#### 2. `src/loader.mjs` - Loader å…¥å£

```javascript
import { register } from 'node:module';

// ä½¿ç”¨ Node.js çš„ register() API æ³¨å†Œ hooks
register(pathToFileURL(hooksPath).href, import.meta.url);
```

**ä½œç”¨**ï¼šä½¿ç”¨ Node.js 18.19+ æä¾›çš„ `register()` API æ³¨å†Œè‡ªå®šä¹‰çš„æ¨¡å—è§£æé’©å­ã€‚

#### 3. `src/hooks.mjs` - æ ¸å¿ƒ Hooks å®ç°

```javascript
export async function resolve(specifier, context, nextResolve) {
    // 1. åˆå§‹åŒ– workspace ä¿¡æ¯ï¼ˆåªæ‰§è¡Œä¸€æ¬¡ï¼‰
    initWorkspace();

    // 2. è·³è¿‡éä¸»å…¥å£å¯¼å…¥ï¼ˆç›¸å¯¹è·¯å¾„ã€å­è·¯å¾„ç­‰ï¼‰
    if (!isMainEntryImport(specifier)) {
        return nextResolve(specifier, context);
    }

    // 3. æ£€æŸ¥æ˜¯å¦æ˜¯ workspace ä¸­çš„åŒ…
    const pkg = workspacePackages.get(specifier);
    if (!pkg || !pkg.monorepoEntry) {
        return nextResolve(specifier, context);
    }

    // 4. è¿”å› monorepo å­—æ®µæŒ‡å®šçš„å…¥å£è·¯å¾„
    const newUrl = pathToFileURL(join(pkg.dir, pkg.monorepoEntry)).href;
    return { url: newUrl, shortCircuit: true };
}
```

**æ ¸å¿ƒé€»è¾‘**ï¼š

1. **åˆå§‹åŒ–é˜¶æ®µ**ï¼šæ‰«æå½“å‰ç›®å½•å‘ä¸ŠæŸ¥æ‰¾ `workspaces` é…ç½®ï¼Œè§£ææ‰€æœ‰æœ¬åœ°åŒ…çš„ `package.json`
2. **è§£æé˜¶æ®µ**ï¼šæ‹¦æˆª `import` è¯­å¥ï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯æœ¬åœ°åŒ…çš„ä¸»å…¥å£
3. **é‡å®šå‘é˜¶æ®µ**ï¼šå¦‚æœåŒ…æœ‰ `monorepo` å­—æ®µï¼Œå°†è§£æç»“æœé‡å®šå‘åˆ°è¯¥å­—æ®µæŒ‡å®šçš„è·¯å¾„

### å…³é”®æŠ€æœ¯ç‚¹

#### Node.js ESM Loader Hooks

Node.js 18.19+ / 20.6+ æä¾›äº† `register()` API æ¥æ³¨å†Œè‡ªå®šä¹‰çš„æ¨¡å—åŠ è½½é’©å­ï¼š

```javascript
import { register } from 'node:module';
register('./hooks.mjs', import.meta.url);
```

æ³¨å†Œåï¼Œæ¯æ¬¡ `import` éƒ½ä¼šå…ˆç»è¿‡è‡ªå®šä¹‰çš„ `resolve()` å‡½æ•°ã€‚

#### Workspace è§£æ

é€šè¿‡è§£ææ ¹ç›®å½•çš„ `package.json` ä¸­çš„ `workspaces` å­—æ®µï¼Œæ”¯æŒä¸¤ç§æ ¼å¼ï¼š

```javascript
// æ ¼å¼1ï¼šæ•°ç»„
{ "workspaces": ["packages/*"] }

// æ ¼å¼2ï¼šå¯¹è±¡
{ "workspaces": { "packages": ["packages/*"] } }
```

#### ä¸»å…¥å£åˆ¤æ–­

åªå¤„ç†åŒ…çš„ä¸»å…¥å£å¯¼å…¥ï¼Œä¸å¤„ç†å­è·¯å¾„ï¼š

```javascript
import "@my/utils"        // âœ… ä¸»å…¥å£ï¼Œä¼šè¢«æ‹¦æˆª
import "@my/utils/helper" // âŒ å­è·¯å¾„ï¼Œèµ°é»˜è®¤é€»è¾‘
import "./local"          // âŒ ç›¸å¯¹è·¯å¾„ï¼Œèµ°é»˜è®¤é€»è¾‘
```

### æ‰§è¡Œæµç¨‹ç¤ºä¾‹

```
ç”¨æˆ·æ‰§è¡Œ: mono app.ts

1. mono CLI å¯åŠ¨
   â””â”€ è°ƒç”¨: tsx --import=loader.mjs app.ts

2. tsx å¯åŠ¨ï¼ŒåŠ è½½ loader.mjs
   â””â”€ register() æ³¨å†Œ hooks.mjs

3. æ‰§è¡Œ app.tsï¼Œé‡åˆ° import "@my/utils"
   â””â”€ è°ƒç”¨ hooks.mjs çš„ resolve()
      â”œâ”€ æ£€æŸ¥: "@my/utils" æ˜¯ workspace åŒ…å—ï¼Ÿ â†’ æ˜¯
      â”œâ”€ è¯»å–: packages/utils/package.json
      â”œâ”€ æ£€æŸ¥: æœ‰ monorepo å­—æ®µå—ï¼Ÿ â†’ æœ‰ "./src/index.ts"
      â””â”€ è¿”å›: file:///path/to/packages/utils/src/index.ts

4. tsx åŠ è½½ packages/utils/src/index.tsï¼ˆæºç ï¼‰
```

## è®¾è®¡åŸåˆ™

1. **é€æ˜å¥—å£³**ï¼š`mono` åªæ˜¯ `tsx` çš„ä»£ç†ï¼Œæ‰€æœ‰å‚æ•°åŸæ ·ä¼ é€’
2. **æœ€å°å¹²é¢„**ï¼šåªæ‹¦æˆªæ¨¡å—è§£æï¼Œä¸åšæ ¡éªŒï¼Œä¸å¤„ç†è·¯å¾„
3. **ç®€å•é…ç½®**ï¼šåªæ”¯æŒç®€å•å­—ç¬¦ä¸²æ ¼å¼ `"monorepo": "./src/index.ts"`
4. **å­è·¯å¾„ä¸å¤„ç†**ï¼šåªå¤„ç†åŒ…çš„ä¸»å…¥å£ï¼ˆå¦‚ `@my/utils`ï¼‰ï¼Œå­è·¯å¾„ï¼ˆå¦‚ `@my/utils/helper`ï¼‰èµ°é»˜è®¤é€»è¾‘

## å¼€å‘

```bash
# å®‰è£…ä¾èµ–
npm install

# è¿è¡Œæµ‹è¯•
npm test
```

## é™åˆ¶

- åªæ”¯æŒ npm workspaces é…ç½®çš„æœ¬åœ°åŒ…è¯†åˆ«
- åªæ”¯æŒç®€å•å­—ç¬¦ä¸²æ ¼å¼çš„ `monorepo` é…ç½®
- å­è·¯å¾„å¯¼å…¥ä¸å— `monorepo` å­—æ®µå½±å“
- éœ€è¦å…¨å±€å®‰è£… tsx

## License

MIT
