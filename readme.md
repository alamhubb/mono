# monorepo-cli

ä¸€ä¸ªè§£å†³ Node.js conditions å…¨å±€æ±¡æŸ“é—®é¢˜çš„ CLI å·¥å…·ã€‚

## å®‰è£…

```bash
npm install -g monorepo-cli
```

## ä½¿ç”¨æ–¹æ³•

`mono` å‘½ä»¤ç”¨æ³•ä¸ `tsx` å®Œå…¨ä¸€è‡´ï¼š

```bash
mono app.ts              # ç­‰ä»·äº tsx app.tsï¼Œä½†æœ¬åœ°åŒ…ç”¨æºç 
mono --no-cache app.ts   # å‚æ•°åŸæ ·ä¼ é€’ç»™ tsx
```

### é…ç½®æ­¥éª¤

1. æ ¹ç›®å½• `package.json` é…ç½® workspacesï¼š

```json
{ "workspaces": ["packages/*"] }
```

2. æœ¬åœ°åŒ…çš„ `package.json` æ·»åŠ  `monorepo` å­—æ®µï¼š

```json
{
  "name": "@my/utils",
  "main": "./dist/index.js",
  "monorepo": "./src/index.ts"
}
```

### æ•ˆæœ

- `mono app.ts` â†’ æœ¬åœ°åŒ…ç”¨æºç ï¼Œç¬¬ä¸‰æ–¹åŒ…**ä¸å—å½±å“**
- `tsx app.ts` â†’ æ‰€æœ‰åŒ…ç”¨é»˜è®¤å…¥å£ï¼ˆç¼–è¯‘äº§ç‰©ï¼‰

## ç›®æ ‡ç¾¤ä½“

**éœ€è¦åœ¨æœ¬åœ°ç»´æŠ¤å¤šä¸ªç›¸äº’ä¾èµ–çš„ npm åŒ…çš„å¼€å‘è€…ã€‚**

### âœ… å¯¹ä½¿ç”¨è€…é€æ˜

- å‘å¸ƒåçš„åŒ…ä¸çº¯ npm å¼€å‘çš„åº“**å®Œå…¨ä¸€æ ·**
- ä½¿ç”¨è€…åªéœ€è¦ npm ç¯å¢ƒï¼Œ**ä¸éœ€è¦å®‰è£… mono**
- æ ‡å‡†çš„ `npm install` å³å¯ä½¿ç”¨

### âœ… å¯¹å¼€å‘è€…å‹å¥½

- åªæœ‰**å¼€å‘é˜¶æ®µ**éœ€è¦ monoï¼Œäº«å—æºç çƒ­æ›´æ–°
- å‘å¸ƒåå°±æ˜¯æ™®é€šçš„ npm åŒ…ï¼Œèµ° `main` / `exports` å…¥å£
- å…¶ä»–å¼€å‘è€… fork é¡¹ç›®åï¼Œ**ä¸éœ€è¦ mono ä¹Ÿèƒ½å¼€å‘**ï¼Œåªéœ€ `npm run build` ç¼–è¯‘ä¸€ä¸‹å³å¯

### âœ… é›¶é”å®š

| åœºæ™¯ | mono | pnpm workspace |
|------|------|----------------|
| ä½¿ç”¨è€…å®‰è£… | `npm install` âœ… | `npm install` âœ… |
| å…¶ä»–å¼€å‘è€… fork | åªéœ€ç¼–è¯‘ âœ… | å¿…é¡»å®‰è£… pnpm + æ”¹å†™ä¾èµ– âŒ |
| åˆ‡æ¢åŒ…ç®¡ç†å™¨ | éšæ—¶åˆ‡æ¢ âœ… | è¢« pnpm ç»‘å®š âŒ |

## æ ¸å¿ƒç—›ç‚¹

åœ¨ Monorepo å¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¸Œæœ›ï¼š
- **å¼€å‘æ—¶**ï¼šç›´æ¥å¼•ç”¨æœ¬åœ°åŒ…çš„ **æºç **ï¼ˆ`src/index.ts`ï¼‰ï¼Œäº«å—çƒ­æ›´æ–°ã€æ— éœ€ç¼–è¯‘
- **ç”Ÿäº§æ—¶**ï¼šå¼•ç”¨ **ç¼–è¯‘äº§ç‰©**ï¼ˆ`dist/index.js`ï¼‰ï¼Œç¡®ä¿å…¼å®¹æ€§

ä½†ç°æœ‰æ–¹æ¡ˆéƒ½æœ‰é—®é¢˜ï¼š

### âŒ `--conditions` çš„å…¨å±€æ±¡æŸ“

```bash
node --conditions=development app.js
```

`development` æ¡ä»¶ä¼šå½±å“**æ‰€æœ‰åŒ…**ï¼ŒåŒ…æ‹¬ `node_modules` ä¸­çš„ç¬¬ä¸‰æ–¹ä¾èµ–ï¼Œå¯¼è‡´ä¸å¯é¢„çŸ¥çš„è¡Œä¸ºã€‚

### âŒ `tsconfig paths` çš„ç»´æŠ¤è´Ÿæ‹…

```json
{
  "compilerOptions": {
    "paths": {
      "@my/utils": ["packages/utils/src/index.ts"],
      "@my/core": ["packages/core/src/index.ts"]
      // æ¯å¢åŠ ä¸€ä¸ªåŒ…éƒ½è¦æ‰‹åŠ¨ç»´æŠ¤...
    }
  }
}
```

éœ€è¦**æ‰‹åŠ¨ç»´æŠ¤**æ¯ä¸ªåŒ…çš„è·¯å¾„æ˜ å°„ï¼Œå®¹æ˜“ä¸ `package.json` ä¸åŒæ­¥ï¼Œè¿˜éœ€è¦é¢å¤–çš„ `tsconfig-paths` loaderã€‚

### âŒ `publishConfig` çš„ä¸å¯åˆ‡æ¢

```json
{
  "main": "./src/index.ts",
  "publishConfig": { "main": "./dist/index.js" }
}
```

å¼€å‘æ—¶**æ— è„‘æŒ‡å‘æºç **ï¼Œæ— æ³•è½»æ˜“åˆ‡æ¢å›"æµ‹è¯•ç¼–è¯‘äº§ç‰©"æ¨¡å¼ã€‚

### âŒ `pnpm workspace:*` çš„ä¼ æŸ“æ€§

```json
{
  "dependencies": {
    "@my/utils": "workspace:*"
  }
}
```

æ‰€æœ‰ fork è¿™ä¸ªåº“çš„å¼€å‘è€…éƒ½**å¿…é¡»å®‰è£… pnpm**ï¼Œå¹¶æ”¹å†™æ‰€æœ‰ä¾èµ–å£°æ˜ã€‚

## ä¸ºä»€ä¹ˆé€‰æ‹© mono

### æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | éš”ç¦»æ€§ | é…ç½®å¤æ‚åº¦ | ç¬¬ä¸‰æ–¹åŒ…å®‰å…¨ | npm å®Œç¾å…¼å®¹ |
|------|--------|-----------|-------------|--------------|
| `--conditions` | âŒ å…¨å±€ç”Ÿæ•ˆ | âœ… ç®€å• | âŒ ä¼šè¢«æ±¡æŸ“ | âœ… æ— éœ€æ”¹é€  |
| `pnpm workspace:*` | âœ… æŒ‰åŒ…é…ç½® | âš ï¸ éœ€é¢å¤–é…ç½® | âœ… å®‰å…¨ | âŒ éœ€æ”¹é€ ä¾èµ– |
| `tsconfig paths` | âœ… æŒ‰åŒ…é…ç½® | âŒ éœ€æ‰‹åŠ¨ç»´æŠ¤ | âœ… å®‰å…¨ | âŒ éœ€æ”¹é€ é…ç½® |
| **mono** | âœ… ä»…æœ¬åœ°åŒ… | âœ… ä¸€ä¸ªå­—æ®µ | âœ… å®‰å…¨ | âœ… æ— éœ€æ”¹é€  |

### æ ¸å¿ƒä¼˜åŠ¿

| ç‰¹æ€§ | mono | å…¶ä»–æ–¹æ¡ˆ |
|------|------|----------|
| ğŸ›¡ï¸ **é˜²æ±¡æŸ“** | ä»…å¯¹ monorepo æœ¬åœ°åŒ…ç”Ÿæ•ˆ | --conditions ä¼šæ±¡æŸ“ node_modules |
| âš¡ **é›¶é…ç½®** | è‡ªåŠ¨è¯†åˆ« npm çš„ workspaces | tsconfig paths éœ€æ‰‹åŠ¨ç»´æŠ¤ |
| ğŸ”§ **npm å…¼å®¹** | å®Œç¾å…¼å®¹ npm | pnpm workspace:* éœ€æ”¹é€ ï¼Œä¸å…¼å®¹ npm |

## å®ç°åŸç†

### æŠ€æœ¯æ ˆ

- **Node.js ESM Loader Hooks**ï¼šNode.js 18.19+ æä¾›çš„ `--import` + `register()` API
- **å¤š Loader é“¾å¼è°ƒç”¨**ï¼šmono çš„ loader å’Œ tsx çš„ loader å…±å­˜

### æ‰§è¡Œæµç¨‹

```
ç”¨æˆ·æ‰§è¡Œ: mono app.ts

1. mono å¯åŠ¨
   â””â”€ spawn('tsx', ['--import=monorepo-loader.mjs', 'app.ts'])

2. tsx å¯åŠ¨ï¼ˆå†…éƒ¨æ˜¯ node + tsx çš„ loaderï¼‰
   ç­‰ä»·äº: node --import=monorepo-loader.mjs --import=tsx-loader app.ts

3. monorepo-loader.mjs è¢«åŠ è½½
   â””â”€ register(hooks.mjs) æ³¨å†Œæˆ‘ä»¬çš„ resolve hook

4. å¼€å§‹æ‰§è¡Œ app.ts

5. é‡åˆ° import "@my/utils"
   â”‚
   â”œâ”€ è°ƒç”¨ hooks.resolve("@my/utils")
   â”‚   â”œâ”€ æ£€æŸ¥ workspacePackages ç¼“å­˜
   â”‚   â”œâ”€ æ‰¾åˆ° @my/utils ä¸”æœ‰ monorepo: "./src/index.ts"
   â”‚   â””â”€ è¿”å› { url: ".../src/index.ts", shortCircuit: true }
   â”‚
   â””â”€ tsx çš„ load hook è¢«è°ƒç”¨
       â””â”€ ç¼–è¯‘ src/index.tsï¼ˆTypeScript â†’ JavaScriptï¼‰

6. ç»§ç»­æ‰§è¡Œ...
```

### Loader é“¾å¼è°ƒç”¨

```
import "@my/utils"
    â”‚
    â–¼
monorepo-loader.resolve()
    â”‚
    â”œâ”€ æ˜¯ workspace åŒ…ä¸”æœ‰ monorepo å­—æ®µï¼Ÿ
    â”‚   â””â”€ æ˜¯ â†’ è¿”å› ./src/index.tsï¼ˆshortCircuit: trueï¼‰
    â”‚
    â””â”€ å¦ â†’ è°ƒç”¨ nextResolve()
              â”‚
              â–¼
        tsx-loader.resolve()  â† tsx å¤„ç† TypeScript
              â”‚
              â–¼
        Node.js é»˜è®¤è§£æ
```

### æ ¸å¿ƒæ–‡ä»¶

| æ–‡ä»¶ | ä½œç”¨ |
|------|------|
| `bin/mono.mjs` | CLI å…¥å£ï¼Œè°ƒç”¨ tsx å¹¶æ³¨å…¥ loader |
| `src/monorepo-loader.mjs` | ä½¿ç”¨ `register()` æ³¨å†Œ hooks |
| `src/hooks.mjs` | å®ç° `resolve()` æ‹¦æˆªæ¨¡å—è§£æ |

## è®¾è®¡åŸåˆ™

1. **é€æ˜å¥—å£³**ï¼š`mono` åªæ˜¯ `tsx` çš„ä»£ç†ï¼Œå‚æ•°åŸæ ·ä¼ é€’
2. **æœ€å°å¹²é¢„**ï¼šåªæ‹¦æˆªæ¨¡å—è§£æï¼Œä¸åšå…¶ä»–å¤„ç†
3. **ç®€å•é…ç½®**ï¼šåªæ”¯æŒç®€å•å­—ç¬¦ä¸²æ ¼å¼ `"monorepo": "./src/index.ts"`
4. **å­è·¯å¾„ä¸å¤„ç†**ï¼šåªå¤„ç†ä¸»å…¥å£ï¼ˆ`@my/utils`ï¼‰ï¼Œå­è·¯å¾„ï¼ˆ`@my/utils/helper`ï¼‰èµ°é»˜è®¤é€»è¾‘

## é™åˆ¶

- åªæ”¯æŒ npm workspaces é…ç½®
- åªæ”¯æŒç®€å•å­—ç¬¦ä¸²æ ¼å¼çš„ `monorepo` é…ç½®
- å­è·¯å¾„å¯¼å…¥ä¸å—å½±å“

## License

MIT
