# ä¸ºä»€ä¹ˆæˆ‘æŠ›å¼ƒ pnpmï¼Œç”¨ 100 è¡Œä»£ç é€ äº†ä¸ª Monorepo å·¥å…·

> TL;DR: æˆ‘åˆ›å»ºäº† [mono](https://github.com/alamhubb/mono) - ä¸€ä¸ªè½»é‡çº§çš„ pnpm workspace æ›¿ä»£æ–¹æ¡ˆï¼Œè®©ä½ çš„é¡¹ç›®ä¿æŒçº¯å‡€çš„ npm ç¯å¢ƒï¼ŒåŒæ—¶äº«å— monorepo çš„å¼€å‘ä½“éªŒã€‚

## æ ¸å¿ƒç—›ç‚¹ï¼špnpm çš„ã€Œé“¾å¼æ±¡æŸ“ã€

å½“æˆ‘å¼€å§‹ç”¨ pnpm workspace ç®¡ç† TypeScript monorepo æ—¶ï¼Œæˆ‘ä»¥ä¸ºæ‰¾åˆ°äº†å®Œç¾çš„è§£å†³æ–¹æ¡ˆã€‚ç›´åˆ°æˆ‘è¯•å›¾å’Œè´¡çŒ®è€…åˆ†äº«æˆ‘çš„é¡¹ç›®ã€‚

```bash
$ git clone my-awesome-project
$ npm install
npm ERR! Invalid tag name "workspace:*"
```

æ¯ä¸€æ¬¡ã€‚éƒ½æ˜¯è¿™æ ·ã€‚

### çº§è”æ•ˆåº”

å‘ç”Ÿäº†ä»€ä¹ˆï¼š
- æˆ‘çš„é¡¹ç›®ç”¨äº† pnpm workspace
- ä»»ä½•äººå…‹éš†å®ƒéƒ½å¿…é¡»å®‰è£… pnpm
- æˆ‘ä»¬çš„ CI/CD éœ€è¦é…ç½® pnpm
- è´¡çŒ®è€…ä¸èƒ½ä½¿ç”¨ä»–ä»¬å–œæ¬¢çš„åŒ…ç®¡ç†å™¨
- `workspace:*` åè®®è®© package.json ä¸ npm/yarn ä¸å…¼å®¹

**ä¸€ä¸ªå†³å®šï¼Œå¼ºè¿«æ•´æ¡ä¾èµ–é“¾éƒ½ç”¨ pnpmã€‚**

## æˆ‘çœŸæ­£éœ€è¦çš„æ˜¯ä»€ä¹ˆ

è€å®è¯´ï¼Œæˆ‘ä¸æ˜¯åœ¨æ­å»º Vercel æˆ– Googleã€‚æˆ‘åªæ˜¯æœ‰ï¼š
- 3-4 ä¸ªæœ¬åœ° TypeScript åŒ…
- å®ƒä»¬ç›¸äº’ä¾èµ–
- æˆ‘æƒ³åŒæ—¶ä¿®æ”¹å®ƒä»¬
- æˆ‘ä¸æƒ³æ¯æ¬¡ä¿®æ”¹åè¿è¡Œ `npm run build`

**å°±è¿™æ ·ã€‚** æˆ‘ä¸éœ€è¦ï¼š
- âŒ å¤æ‚çš„ workspace é…ç½®
- âŒ ä¸“æœ‰åè®®ï¼ˆ`workspace:*`ï¼‰
- âŒ å¼ºè¿«æˆ‘çš„å›¢é˜Ÿå®‰è£…å¦ä¸€ä¸ªåŒ…ç®¡ç†å™¨
- âŒ è½¯é“¾æ¥è°ƒè¯•å™©æ¢¦

## è§£å†³æ–¹æ¡ˆï¼šè¿è¡Œæ—¶æºç è§£æ

ä¸å…¶åœ¨å®‰è£…æ—¶ç®¡ç†è½¯é“¾æ¥ï¼ˆåƒ pnpmï¼‰ï¼Œä¸ºä»€ä¹ˆä¸åœ¨è¿è¡Œæ—¶è§£ææ¨¡å—å‘¢ï¼Ÿ

`javascript
// ä½ çš„ä»£ç 
import { utils } from 'my-local-pkg'

// ä¼ ç»Ÿæ–¹å¼ï¼špnpm è½¯é“¾æ¥ node_modules/my-local-pkg  ../packages/my-local-pkg/dist
// mono æ–¹å¼ï¼šè¿è¡Œæ—¶æ‹¦æˆª  è§£æåˆ° ../packages/my-local-pkg/src/index.ts
`

### å·¥ä½œåŸç†

Mono ä½¿ç”¨ Node.js ESM Loader Hooks æ¥ï¼š
1. æ‰«æä½ çš„é¡¹ç›®æŸ¥æ‰¾åŒ…ï¼ˆä»»ä½•æœ‰ package.json çš„ç›®å½•ï¼‰
2. å»ºç«‹æ˜ å°„ï¼šåŒ…å  ç»å¯¹è·¯å¾„/src/index.ts
3. æ‹¦æˆªå¯¼å…¥å¹¶é‡å®šå‘åˆ°æºç 

**æ— è½¯é“¾æ¥ã€‚æ— æ„å»ºäº§ç‰©ã€‚åªæœ‰ TypeScript æºç ã€‚**

## ç»™æˆ‘çœ‹ä»£ç 

`ash
# å®‰è£…
npm install -g mono-mjs

# è¿è¡Œ - æœ¬åœ°åŒ…è‡ªåŠ¨è§£æ
mono ./src/index.ts

# å¯ä»¥é…åˆ Viteã€Webpack ç­‰ä»»ä½•å·¥å…·
mono ./node_modules/vite/bin/vite.js
`

å°±æ˜¯è¿™ä¹ˆç®€å•ã€‚æ— éœ€é…ç½®æ–‡ä»¶ã€‚æ— éœ€ä¿®æ”¹ package.jsonã€‚

## å¯¹æ¯”è¡¨æ ¼

### pnpm workspace vs Mono

| æ–¹é¢ | pnpm workspace | Mono |
|------|----------------|------|
| å®‰è£… | å¿…é¡»å®‰è£… pnpm | å¯é€‰ |
| é…ç½®æ–‡ä»¶ | éœ€è¦ pnpm-workspace.yaml | ä¸éœ€è¦ |
| package.json | éœ€è¦ä¿®æ”¹ä¸º workspace:* | ä¸éœ€è¦ä¿®æ”¹ |
| å…‹éš†åä½¿ç”¨ | å¿…é¡» pnpm install | npm/yarn/pnpm éƒ½å¯ä»¥ |
| ä¾èµ–åŒ… | éœ€è¦å…ˆæ„å»º | ç›´æ¥ä½¿ç”¨æºç  |
| å›¢é˜Ÿåä½œ | æ‰€æœ‰äººå¿…é¡»ç”¨ pnpm | ä¸å¼ºåˆ¶ |

### å„æ–¹æ¡ˆæ¨ªå‘å¯¹æ¯”

| æ–¹æ¡ˆ | å…å®‰è£… | å…ç¼–è¯‘ | é›¶é…ç½® | è‡ªåŠ¨å‘ç° | å¤æ‚åº¦ |
|------|:------:|:------:|:------:|:--------:|:------:|
| npm åŸç”Ÿ | âŒ | âŒ | âŒ | âŒ | é«˜ |
| pnpm workspace | âœ… | âš ï¸ | âŒ | âœ… | ä¸­ |
| tsconfig paths | âœ… | âœ… | âŒ | âŒ | ä½ |
| Nx | âœ… | âœ… | âŒ | âœ… | æé«˜ |
| **mono** | âœ… | âœ… | âœ… | âœ… | **æä½** |

> âš ï¸ = è§†é…ç½®è€Œå®š

### å¯¹æ¯” npm `file:` åè®®

ä¼ ç»Ÿ npm æœ¬åœ°ä¾èµ–æ–¹å¼ï¼š

`json
{ "my-lib": "file:../packages/my-lib" }
`

| ä¿®æ”¹æœ¬åœ°åŒ…å | npm `file:` | mono |
|--------------|:-----------:|:----:|
| éœ€è¦é‡æ–°è¿è¡Œ `npm install`ï¼Ÿ | âœ… æ˜¯ | âŒ å¦ |
| ä¿®æ”¹ç«‹å³ç”Ÿæ•ˆï¼Ÿ | âŒ å¦ | âœ… æ˜¯ |

**ä½¿ç”¨ `file:` åè®®æ—¶**ï¼Œnpm ä¼šå°†åŒ…å¤åˆ¶åˆ° `node_modules`ã€‚æ¯æ¬¡ä¿®æ”¹æœ¬åœ°åŒ…åï¼Œå¿…é¡»é‡æ–°è¿è¡Œ `npm install` æ¥æ›´æ–°å‰¯æœ¬ã€‚

**ä½¿ç”¨ mono æ—¶**ï¼Œå¯¼å…¥åœ¨è¿è¡Œæ—¶è¢«é‡å®šå‘åˆ°æºç ã€‚æ— éœ€å¤åˆ¶ï¼Œæ— éœ€é‡æ–°å®‰è£…ã€‚

> ğŸ’¡ **æ³¨æ„**ï¼šæ¥è‡ª npm ä»“åº“çš„ç¬¬ä¸‰æ–¹åŒ…ä»ç„¶éœ€è¦ `npm install`ã€‚ã€Œæ— éœ€å®‰è£…ã€çš„ä¼˜åŠ¿ä»…é€‚ç”¨äº**æœ¬åœ°åŒ…**ã€‚

## çœŸå®ä½¿ç”¨åœºæ™¯

æˆ‘ä¸€ç›´åœ¨ç”¨ mono å¼€å‘ï¼š
- **ç¼–è¯‘å™¨å·¥å…·é“¾**ï¼š5 ä¸ªç›¸äº’ä¾èµ–çš„åŒ…ï¼ˆparser, transformer, codegen ç­‰ï¼‰
- **Vite æ’ä»¶å¼€å‘**ï¼šæ’ä»¶ + æµ‹è¯•é¡¹ç›®åœ¨ä¸€ä¸ªä»“åº“
- **æ•™å­¦**ï¼šå­¦ç”Ÿå¯ä»¥ç”¨ `npm install` å…‹éš†ï¼Œæ— éœ€ pnpm

### å‘ç”Ÿäº†ä»€ä¹ˆå˜åŒ–

**ä¹‹å‰ï¼ˆpnpm workspaceï¼‰ï¼š**
`ash
# ä¿®æ”¹åŒ… A
cd packages/core
npm run build

# åœ¨åŒ… B ä¸­æµ‹è¯•
cd ../app
npm run dev
`

**ä¹‹åï¼ˆmonoï¼‰ï¼š**
`ash
# ä¿®æ”¹åŒ… Aï¼Œç«‹å³æµ‹è¯•
mono ./packages/app/src/index.ts
`

## ä»€ä¹ˆæ—¶å€™ä¸è¯¥ç”¨ Mono

- **500+ åŒ…çš„ monorepo**ï¼šç”¨ Nx æˆ– Turborepo
- **éœ€è¦ä¸¥æ ¼ç‰ˆæœ¬ç®¡ç†**ï¼šéœ€è¦ç²¾ç¡®æ§åˆ¶æ¯ä¸ªåŒ…çš„ç‰ˆæœ¬ä¾èµ–å…³ç³»
- **å›¢é˜Ÿå·²æ·±åº¦ä½¿ç”¨ pnpm workspace**ï¼šè¿ç§»æˆæœ¬å¯èƒ½ä¸å€¼å¾—

## æ ¸å¿ƒç†å¿µ

> ä½ çš„é¡¹ç›®åº”è¯¥ä¿æŒ**æ ‡å‡†çš„ npm é¡¹ç›®**ã€‚å·¥å…·åº”è¯¥å¢å¼ºï¼Œè€Œä¸æ˜¯æ›¿ä»£ã€‚

Mono ä¸ä¼šï¼š
- ä¿®æ”¹ä½ çš„ package.json
- åˆ›å»ºæ–°çš„é…ç½®æ–‡ä»¶
- å¼ºè¿«ä½ çš„å›¢é˜Ÿä½¿ç”¨ç‰¹å®šåŒ…ç®¡ç†å™¨
- æŠŠä½ é”å®šåœ¨ä¸“æœ‰åè®®é‡Œ

å®ƒåªæ˜¯è®© `import` èƒ½åœ¨å¼€å‘æ—¶ç›´æ¥ä½¿ç”¨ä½ çš„æœ¬åœ° TypeScript æ–‡ä»¶ã€‚

## å¿«é€Ÿå¼€å§‹

`ash
# 1. å®‰è£…
npm install -g mono-mjs

# 2. ï¼ˆå¯é€‰ï¼‰åœ¨æœ¬åœ°åŒ…çš„ package.json æ·»åŠ å…¥å£
{
  "name": "my-package",
  "local": "./src/index.ts"   // å¯é€‰ï¼Œé»˜è®¤å°±æ˜¯è¿™ä¸ª
}

# 3. è¿è¡Œ
mono ./src/index.ts
`

## å·¥ä½œåŸç†

Mono åˆ©ç”¨ Node.js çš„ ESM Loader Hooksï¼Œåœ¨è¿è¡Œæ—¶æ‹¦æˆªæ¨¡å—è§£æï¼š

`
ä½ çš„ä»£ç : import { utils } from 'my-utils'
                    
Mono æ‹¦æˆª: æ£€æµ‹åˆ° my-utils æ˜¯æœ¬åœ°åŒ…
                    
é‡å®šå‘:  /path/to/my-utils/src/index.ts
`

è¿™æ„å‘³ç€ï¼š
- âœ… **ç›´æ¥ä½¿ç”¨ TypeScript æºç ** - æ— éœ€æ„å»º
- âœ… **ä¿®æ”¹ç«‹å³ç”Ÿæ•ˆ** - æ— éœ€é‡æ–°æ„å»º
- âœ… **package.json ä¿æŒå¹²å‡€** - æ²¡æœ‰ workspace:* åè®®

## è¯•è¯•çœ‹

`ash
npm install -g mono-mjs
mono ./your-entry.ts
`

ï¿½ï¿½ **GitHub**: [https://github.com/alamhubb/mono](https://github.com/alamhubb/mono)
ğŸ“¦ **NPM**: [mono-mjs](https://www.npmjs.com/package/mono-mjs)

---

## è®¨è®º

ä½ æ€ä¹ˆçœ‹ï¼Ÿå¯¹äºä¸­å°å‹ monorepoï¼Œã€Œä¸€ä¸ªåŒ…ç®¡ç†å™¨ç»Ÿæ²»ä¸€åˆ‡ã€çš„æ–¹å¼æ˜¯å¿…éœ€çš„å—ï¼Ÿæˆ‘ä»¬æ˜¯å¦éœ€è¦æ›´å¤šè½»é‡çº§çš„æ›¿ä»£æ–¹æ¡ˆï¼Ÿ

æˆ‘å¾ˆæƒ³å¬å¬ä½ çš„æƒ³æ³•ï¼Œç‰¹åˆ«æ˜¯å¦‚æœä½ æ›¾ç»åœ¨ pnpm workspace æˆ– npm link å·¥ä½œæµä¸­é‡åˆ°è¿‡å›°éš¾ã€‚

---

**å…³é”®è¯**ï¼šmonorepo, typescript, npm, pnpm æ›¿ä»£æ–¹æ¡ˆ, æ—  workspace, æœ¬åœ°åŒ…, å¼€å‘ä½“éªŒ, è½»é‡çº§ monorepo, é›¶é…ç½®
